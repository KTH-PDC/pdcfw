#!/bin/bash

# pdcfw - manages PDC Linux Netfilter/IPtables firewall configuration

# pdcfw - pdcfw main
# Author: Ilari Korhonen, KTH Royal Institute of Technology
#
# Copyright (C) 2018 KTH Royal Institute of Technology. All rights reserved.
# See LICENSE file for more information.


# source in functions from distribution directory
source $(dirname $0)/functions.sh

# if we have a configuration file, source it in
if [ -f ${configfile} ]; then
    source ${configfile}
fi

# source in the main function
if [ -x ${MAIN_FUNC} ]; then
    source ${MAIN_FUNC}
else
    echo "pdcfw: file ${MAIN_FUNC} not present or executable, aborting!" > /dev/stderr
    exit -1
fi

# process command line arguments and select action
case "$1" in
    show)
	shift
	show_action $@
	;;

    dry)
	shift
	printf "${prog}: executing dry run, resulting rule set:\n\n" > /dev/stderr

	# execute the whole program with a dummy cmd
	cat <(commit=true fwcmd="echo" _main)

	printf "\n${prog}: dry run complete - apply rule set by executing pdcfw apply!\n" > /dev/stderr
	;;

    apply)
	shift
	printf "${prog}: saving in-memory firewall rule set to ${IPTABLES_RULES}...\n"
	save
	printf "${prog}: flushing in-memory firewall rule set...\n"
	flush
	printf "${prog}: executing rule set build starting from ${mainfunc}...\n"
	${restore} <(commit=true fwcmd="echo" _main)
	printf "${prog}: rule set commit complete - view results with pdcfw show running!\n" 
	;;

    flush)
	shift
	printf "${prog}: flushing IPTables ruleset...\n"
	${fwcmd} --flush
	;;

    restore)
	${restore} < ${IPTABLES_RULES}
	;;
	
    *)
	echo "${prog}: usage ${prog} {show|dry|apply|...}"
	exit 1
	;;
esac
